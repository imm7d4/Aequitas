# US-11.2 - Market Depth & Liquidity Visualization

**Epic:** Order Book & Market Depth  
**Phase:** Phase 11 - Order Book  
**Status:** Not Started  
**Priority:** Medium  
**Complexity:** Medium  

## User Story

As a **professional trader**,  
I want advanced visualizations of market depth and liquidity patterns,  
so that I can identify support/resistance levels, assess market sentiment, and detect potential price movements.

## Acceptance Criteria

### 1. Depth Chart Visualization
- [ ] Interactive depth chart showing cumulative bid/ask volumes
- [ ] X-axis: Price levels
- [ ] Y-axis: Cumulative volume
- [ ] Visual area chart with bid (green) and ask (red) areas
- [ ] Crosshair showing exact price and volume on hover
- [ ] Zoom and pan capabilities

### 2. Liquidity Heatmap
- [ ] Color-coded heatmap showing order concentration
- [ ] Darker colors indicate higher liquidity at price levels
- [ ] Time-based view showing liquidity changes over time
- [ ] Identify "walls" (large orders at specific prices)

### 3. Order Book Imbalance Indicator
- [ ] Calculate bid/ask imbalance ratio
- [ ] Visual gauge showing market pressure (buy vs sell)
- [ ] Historical imbalance trend chart
- [ ] Alert when imbalance exceeds threshold (e.g., 70/30)

### 4. Volume Profile
- [ ] Display volume distribution across price levels
- [ ] Identify high-volume nodes (HVN) and low-volume nodes (LVN)
- [ ] Point of Control (POC) - price level with highest volume
- [ ] Value Area (VA) - price range containing 70% of volume

### 5. Market Microstructure Metrics
- [ ] **Depth-Weighted Quoted Spread**: Average spread weighted by volume at each level
- [ ] **Effective Spread**: 2 × |Trade Price − Mid Price| (requires trade data, integrate with US-10.1)
- [ ] **Bid-Ask Spread %**: Spread as percentage of mid-price
- [ ] **Order Book Depth**: Total volume within N% of mid-price
- [ ] **Liquidity Score**: Composite metric of depth and spread
- [ ] **Normalized Liquidity**: Current liquidity vs 30-day historical average

## Technical Requirements

### Backend

#### New Service: `MarketDepthService`
- **Method**: `GetDepthChart(instrumentID string) (*DepthChart, error)`
  - Calculate cumulative bid/ask volumes
  - Generate price-volume pairs for charting
  
- **Method**: `GetLiquidityMetrics(instrumentID string) (*LiquidityMetrics, error)`
  - Calculate order book imbalance
  - Compute effective spread
  - Determine liquidity score
  
- **Method**: `GetVolumeProfile(instrumentID string, timeRange string) (*VolumeProfile, error)`
  - Aggregate historical volume by price level
  - Identify HVN, LVN, POC, and Value Area

#### New Models
```go
type DepthChart struct {
    InstrumentID string          `json:"instrument_id"`
    BidDepth     []PriceVolume   `json:"bid_depth"`
    AskDepth     []PriceVolume   `json:"ask_depth"`
    MidPrice     float64         `json:"mid_price"`
}

type PriceVolume struct {
    Price            float64 `json:"price"`
    CumulativeVolume int     `json:"cumulative_volume"`
}

type LiquidityMetrics struct {
    BidAskImbalance        float64 `json:"bid_ask_imbalance"` // -1 to 1
    DepthWeightedSpread    float64 `json:"depth_weighted_spread"`
    EffectiveSpread        float64 `json:"effective_spread"` // From actual trades
    SpreadPercent          float64 `json:"spread_percent"`
    DepthScore             float64 `json:"depth_score"`
    LiquidityScore         float64 `json:"liquidity_score"`
    NormalizedLiquidity    float64 `json:"normalized_liquidity"` // vs 30-day avg
    HistoricalAvgLiquidity float64 `json:"historical_avg_liquidity"`
}

type VolumeProfile struct {
    PriceLevels []PriceVolumeNode `json:"price_levels"`
    POC         float64           `json:"poc"` // Point of Control
    ValueAreaHigh float64         `json:"value_area_high"`
    ValueAreaLow  float64         `json:"value_area_low"`
}

type PriceVolumeNode struct {
    Price  float64 `json:"price"`
    Volume int     `json:"volume"`
    Type   string  `json:"type"` // "HVN", "LVN", "POC", "VA"
}
```

#### New Endpoints
- `GET /api/market-depth/:instrumentId/chart` - Depth chart data
- `GET /api/market-depth/:instrumentId/metrics` - Liquidity metrics
- `GET /api/market-depth/:instrumentId/volume-profile?range=1d` - Volume profile

### Frontend

#### New Components
- **`DepthChart.tsx`**: Interactive depth chart using lightweight-charts or D3.js
  - Area chart with bid/ask cumulative volumes
  - Crosshair and tooltips
  - Zoom controls
  
- **`LiquidityHeatmap.tsx`**: Heatmap visualization
  - Color-coded grid showing order concentration
  - Time on X-axis, price on Y-axis
  
- **`OrderBookImbalance.tsx`**: Imbalance gauge
  - Circular gauge or bar chart
  - Color-coded (green for buy pressure, red for sell pressure)
  - Historical trend line
  
- **`VolumeProfile.tsx`**: Volume profile chart
  - Horizontal histogram showing volume at each price
  - Highlight HVN, LVN, POC, and Value Area

#### New Hooks
- **`useMarketDepth.ts`**: Fetch and manage market depth data
- **`useLiquidityMetrics.ts`**: Real-time liquidity metrics
- **`useVolumeProfile.ts`**: Volume profile data management

#### New Services
- **`marketDepthService.ts`**: API integration for depth analytics

## Dependencies

- US-11.1: Real-time Order Book Display (base order book data)
- US-2.3.1: Live Stock Charts (charting infrastructure)
- US-10.1: Trade Diagnostics (volume analytics patterns)

## Implementation Notes

### Calculation Details

#### Bid-Ask Imbalance
```
Imbalance = (BidVolume - AskVolume) / (BidVolume + AskVolume)
Range: -1 (all asks) to +1 (all bids)
```

#### Depth-Weighted Quoted Spread (NOT Effective Spread)
```
DepthWeightedSpread = Σ(Spread_i * Volume_i) / Σ(Volume_i)
Where Spread_i = Ask_i - Bid_i at each level

Note: This is NOT the same as Effective Spread.
```

#### Effective Spread (Requires Trade Data)
```
EffectiveSpread = 2 × |Trade Price − Mid Price|

This requires actual trade execution data.
Integration point: US-10.1 Trade Diagnostics
```

#### Normalized Liquidity Score
```
NormalizedLiquidity = CurrentLiquidity / 30DayAvgLiquidity

Where:
  CurrentLiquidity = (DepthScore * 0.6) + (SpreadScore * 0.4)
  DepthScore = min(TotalVolume / Threshold, 1.0)
  SpreadScore = 1 - min(SpreadPercent / MaxSpread, 1.0)

This makes liquidity comparable across instruments:
  < 0.5: Very thin (warning)
  0.5-1.0: Below average
  1.0-1.5: Normal
  > 1.5: High liquidity
```

### Performance Considerations
- Cache depth chart calculations for 1 second
- Use server-side aggregation for volume profile
- Lazy load heatmap data (only visible time range)
- Throttle real-time metric updates to 1 update/second
- **Calculate 30-day liquidity average in background job** (daily update)
- Store historical liquidity metrics for normalization

### Edge Cases
- **Thin Markets**: Show warning when normalized liquidity < 0.5
- **Wide Spreads**: Adjust chart scaling for readability
- **Data Gaps**: Interpolate missing price levels for smooth charts
- **Extreme Imbalance**: Cap imbalance indicator at reasonable limits
- **New Instruments**: Use platform-wide average until 30-day history available

## Testing Requirements

### Unit Tests
- [ ] Test cumulative volume calculation
- [ ] Test imbalance ratio calculation
- [ ] Test effective spread calculation
- [ ] Test liquidity score algorithm
- [ ] Test volume profile aggregation (HVN, LVN, POC)

### Integration Tests
- [ ] Test depth chart data API
- [ ] Test liquidity metrics API
- [ ] Test volume profile API with different time ranges

### E2E Scenarios
- [ ] User views depth chart and interacts with crosshair
- [ ] User sees liquidity heatmap update in real-time
- [ ] User monitors order book imbalance gauge
- [ ] User identifies support/resistance from volume profile

## Audit Trail

| Date | Author | Change |
|------|--------|--------|
| 2026-01-18 | AI Assistant | Initial creation of US-11.2 |
| 2026-01-18 | AI Assistant | Refinement: Corrected effective spread formula, added depth-weighted quoted spread, added normalized liquidity score |
