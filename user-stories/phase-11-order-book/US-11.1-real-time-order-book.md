# US-11.1 - Real-time Order Book & Price-Level Liquidity

**Epic:** Order Book & Market Depth  
**Phase:** Phase 11 - Order Book  
**Status:** Not Started  
**Priority:** High  
**Complexity:** High  

## User Story

As a **retail trader**,  
I want to view the real-time order book showing all pending buy and sell orders for an instrument,  
so that I can understand market depth, liquidity, and make informed trading decisions based on supply and demand dynamics.

## Acceptance Criteria

### 1. Order Book Visualization
- [ ] Display a two-sided order book with **Bid** (buy) and **Ask** (sell) sides
- [ ] Show price levels sorted by best price (highest bid, lowest ask at top)
- [ ] Display quantity available at each price level
- [ ] Show total number of orders at each price level
- [ ] Highlight the **spread** (difference between best bid and best ask)
- [ ] Display **mid-price** indicator row between bids and asks
- [ ] Color-code bid side (green) and ask side (red) for visual clarity
- [ ] Show **relative size** visualization (depth bars relative to max visible level)

### 2. Real-time Updates (Snapshot + Delta Model)
- [ ] **Initial Load**: Receive full order book snapshot
- [ ] **Incremental Updates**: Receive delta messages for changes
- [ ] **Sequence Numbers**: Every message has monotonic sequence number
- [ ] **Gap Detection**: Detect missed updates and request resync
- [ ] Order book updates in real-time as new orders are placed
- [ ] Order book updates when orders are cancelled or filled
- [ ] Smooth animations for price level changes (no jarring jumps)
- [ ] WebSocket-based updates for sub-second latency
- [ ] Handle high-frequency updates without UI lag

### 3. Market Depth Information
- [ ] Display cumulative volume at each price level
- [ ] Show percentage of total volume at each level
- [ ] Visual depth chart (horizontal bars showing relative volume)
- [ ] Configurable depth levels (5, 10, 20, 50 levels)
- [ ] Total bid/ask volume summary

### 4. User Interactions
- [ ] Click on price level to auto-fill order entry form
- [ ] Hover to see detailed breakdown of orders at that level
- [ ] Toggle between compact and detailed view
- [ ] Refresh button for manual order book reload
- [ ] **Freeze/unfreeze updates** with timestamp display ("Frozen at HH:MM:SS.mmm")
- [ ] Compare frozen vs live state side-by-side

### 5. Integration with Trading
- [ ] Order book accessible from instrument detail page
- [ ] Dedicated Order Book tab in main navigation
- [ ] Quick access to order book from watchlist
- [ ] Show user's own orders highlighted in the book

## Technical Requirements

### Backend

#### New Models: Order Book with Snapshot/Delta Support
```go
type OrderBookLevel struct {
    Price       float64   `json:"price"`
    Quantity    int       `json:"quantity"`
    OrderCount  int       `json:"order_count"`
    Side        string    `json:"side"` // "BID" or "ASK"
}

type OrderBook struct {
    InstrumentID string            `json:"instrument_id"`
    Symbol       string            `json:"symbol"`
    Bids         []OrderBookLevel  `json:"bids"`
    Asks         []OrderBookLevel  `json:"asks"`
    Spread       float64           `json:"spread"`
    MidPrice     float64           `json:"mid_price"`
    Sequence     int64             `json:"sequence"`
    LastUpdate   time.Time         `json:"last_update"`
}

// Internal: Time-priority queue (not exposed to clients)
type OrderBookQueue struct {
    Price  float64    `json:"price"`
    Orders []uint     `json:"order_ids"` // FIFO queue of order IDs
}

// Delta message for incremental updates
type OrderBookDelta struct {
    InstrumentID     string  `json:"instrument_id"`
    Price            float64 `json:"price"`
    Side             string  `json:"side"` // "BID" or "ASK"
    QuantityChange   int     `json:"quantity_change"`   // +/- delta
    OrderCountChange int     `json:"order_count_change"` // +/- delta
    Sequence         int64   `json:"sequence"`
    Timestamp        time.Time `json:"timestamp"`
}

// WebSocket message types
type OrderBookMessage struct {
    Type string      `json:"type"` // "SNAPSHOT" or "DELTA"
    Data interface{} `json:"data"` // OrderBook or OrderBookDelta
}

type OrderBookEventType string

const (
    OrderPlaced    OrderBookEventType = "ORDER_PLACED"
    OrderCancelled OrderBookEventType = "ORDER_CANCELLED"
    OrderExecuted  OrderBookEventType = "ORDER_EXECUTED"
)
```

#### New Service: `OrderBookService`
> **CRITICAL**: Order book is **in-memory**, owned by Matching Engine, NOT built from DB.

- **Method**: `GetOrderBookSnapshot(instrumentID string, depth int) (*OrderBook, error)`
  - Return current in-memory order book state
  - Include sequence number for sync
  - Calculate spread and mid-price
  
- **Method**: `SubscribeToOrderBook(instrumentID string) chan OrderBookMessage`
  - Send initial SNAPSHOT message
  - Stream DELTA messages on changes
  - Each message has monotonic sequence number
  
- **Method**: `HandleOrderEvent(event OrderBookEventType, orderID uint)`
  - Update in-memory order book
  - Maintain time-priority queues internally
  - Emit delta to subscribers
  - Async persist to DB for audit/recovery
  
- **Method**: `ResyncOrderBook(instrumentID string, fromSequence int64) ([]OrderBookMessage, error)`
  - Handle gap recovery
  - Return missed deltas or full snapshot

#### New Controller: `OrderBookController`
- **Endpoint**: `GET /api/order-book/:instrumentId?depth=10`
  - Returns current order book snapshot
  
- **WebSocket**: `WS /api/order-book/:instrumentId/stream`
  - Streams real-time order book updates

#### Repository Updates
- **OrderRepository**: Add method to fetch pending orders grouped by price level
- Optimize queries for high-frequency reads

### Frontend

#### New Components
- **`OrderBook.tsx`**: Main order book display component
  - Two-column layout (Bids | Asks)
  - **Mid-price separator row** between bids and asks
  - Price, Quantity, Total columns
  - **Relative depth bars** (scaled to max visible level)
  - Freeze mode with timestamp display
  
- **`OrderBookLevel.tsx`**: Individual price level row
  - Clickable for order entry
  - Hover tooltips with details
  - Relative size visualization
  
- **`DepthChart.tsx`**: Visual representation of market depth
  - Horizontal bar chart
  - Cumulative volume visualization

#### New Hooks
- **`useOrderBook.ts`**: Hook to manage order book data
  - WebSocket connection management
  - **Snapshot/delta state reconciliation**
  - **Sequence number tracking and gap detection**
  - Auto-resync on gaps
  - Depth level configuration
  
- **`useOrderBookSubscription.ts`**: WebSocket subscription hook
  - Auto-reconnect on disconnect
  - Message parsing (SNAPSHOT vs DELTA)
  - State updates with sequence validation
  - "Out of Sync" warning display

#### New Services
- **`orderBookService.ts`**: API integration
  - Fetch order book snapshot
  - Parse WebSocket messages
  - Calculate derived metrics (spread, depth percentages)

#### State Management
- Store order book data in context or state management
- Efficient updates to prevent re-renders
- Memoization for expensive calculations

## Dependencies

- US-4.1.1: Order Placement (orders must exist)
- US-6.1: Matching Engine (order execution updates book)
- US-2.2.1: Market Data Feed (WebSocket infrastructure)

## Implementation Notes

### Performance Considerations
- **In-Memory Architecture**: Order book lives in Matching Engine memory, NOT database
- **Delta Compression**: Send only changes, not full book (reduces bandwidth 90%+)
- **Sequence Numbers**: Enable gap detection without full state comparison
- **Throttling**: Throttle WebSocket updates to max 10 updates/second to prevent UI overload
- **Virtual Scrolling**: Use virtual scrolling for deep order books (50+ levels)
- **Debouncing**: Debounce rapid updates during high volatility
- **Database Role**: DB is for audit/recovery only, async writes

### Edge Cases
- **Empty Order Book**: Show "No orders" message when book is empty
- **One-sided Market**: Handle cases where only bids or only asks exist
- **Large Spreads**: Highlight unusually large spreads as warning
- **Stale Data**: Show warning if order book hasn't updated in >5 seconds
- **WebSocket Disconnect**: Gracefully handle disconnections and auto-reconnect
- **Sequence Gap**: Detect via sequence numbers, auto-request resync
- **Packet Loss**: Delta model prevents permanent desync
- **Reconnect**: Request snapshot on reconnect to ensure consistency

### Security & Privacy
- Users should only see aggregated order book, not individual order details
- **Time priority tracked internally** but NOT exposed (prevents gaming)
- Admin users may have access to detailed order breakdown
- Rate limiting on order book API to prevent abuse

### Non-Goals
- ❌ No individual order identities exposed to users
- ❌ No dark pool / hidden liquidity
- ❌ No predictive signals or order flow analysis
- ❌ No market maker identification

## Testing Requirements

### Unit Tests
- [ ] Test order book aggregation logic (grouping by price level)
- [ ] Test bid/ask sorting (descending/ascending)
- [ ] Test spread calculation
- [ ] Test cumulative volume calculations

### Integration Tests
- [ ] Test WebSocket connection and message handling
- [ ] Test order book updates on new order placement
- [ ] Test order book updates on order cancellation
- [ ] Test order book updates on order execution

### E2E Scenarios
- [ ] User views order book for an instrument
- [ ] User clicks on price level to auto-fill order form
- [ ] Order book updates in real-time as orders are placed
- [ ] Order book handles high-frequency updates smoothly
- [ ] User's own orders are highlighted in the book

### Performance Tests
- [ ] Load test: 1000+ concurrent users viewing order book
- [ ] Stress test: 100+ orders/second updates
- [ ] Measure latency: Order placement to order book update <100ms

## Audit Trail

| Date | Author | Change |
|------|--------|--------|
| 2026-01-18 | AI Assistant | Initial creation of US-11.1 |
| 2026-01-18 | AI Assistant | Major refinement: Added snapshot/delta model, time priority, in-memory architecture, sequence numbers, mid-price, relative sizing, freeze timestamps |
