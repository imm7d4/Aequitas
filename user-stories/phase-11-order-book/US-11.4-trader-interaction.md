# US-11.4 - Trader Order Interaction Layer

**Epic:** Order Book & Market Depth  
**Phase:** Phase 11 - Order Book  
**Status:** Not Started  
**Priority:** High  
**Complexity:** Medium  

## User Story

As a **professional trader**,  
I want to place orders directly from the order book with one-click actions and keyboard shortcuts,  
so that I can execute trades quickly and efficiently without switching between order book and order entry form.

## Acceptance Criteria

### 1. One-Click Order Placement
- [ ] Click on bid price level → **Buy limit order** at that price
- [ ] Click on ask price level → **Sell limit order** at that price
- [ ] Default quantity from user preferences or last order
- [ ] Visual confirmation (highlight clicked level briefly)
- [ ] Order appears in order book immediately (optimistic update)

### 2. Quick Action Buttons
- [ ] **"Join Bid"** button: Place buy limit order at best bid price
- [ ] **"Lift Ask"** button: Place sell market/limit order at best ask price
- [ ] **"Hit Bid"** button: Place sell market/limit order at best bid price
- [ ] **"Join Ask"** button: Place sell limit order at best ask price
- [ ] Configurable quantity for quick actions

### 3. Drag-to-Price (Ladder Style)
- [ ] Drag from order entry panel to order book price level
- [ ] Visual line showing drag path
- [ ] Drop on price level to set limit price
- [ ] Works for both buy and sell orders
- [ ] Cancel drag with Esc key

### 4. Keyboard Shortcuts
- [ ] **B**: Buy at selected price level
- [ ] **S**: Sell at selected price level
- [ ] **↑/↓**: Navigate price levels
- [ ] **Enter**: Place order at selected level
- [ ] **Shift + Click**: Set custom quantity
- [ ] **Ctrl + Click**: Place market order instead of limit

### 5. Order Size Adjustment
- [ ] Shift + Click on price level → Show quantity input dialog
- [ ] Quick size buttons: 10, 50, 100, 500, 1000 shares
- [ ] Remember last used quantity per instrument
- [ ] Validate against position limits and buying power

### 6. Visual Feedback
- [ ] Hover effect on price levels (show "Click to buy/sell at ₹X")
- [ ] Pending order confirmation (spinner/loading state)
- [ ] Success animation (green flash)
- [ ] Error notification (red flash + toast message)
- [ ] Show user's own pending orders highlighted in book

### 7. Order Modification from Book
- [ ] Right-click on user's own order in book → Context menu
  - Modify quantity
  - Modify price
  - Cancel order
- [ ] Drag user's own order to different price level to modify
- [ ] Confirmation dialog for modifications

## Technical Requirements

### Backend

No new backend changes required. Reuse existing:
- `POST /api/orders` (Order placement)
- `PUT /api/orders/:id` (Order modification)
- `DELETE /api/orders/:id` (Order cancellation)

### Frontend

#### New Components
- **`OrderBookInteractionLayer.tsx`**: Overlay for click handling
  - Transparent layer over order book
  - Capture click events on price levels
  - Show hover tooltips
  
- **`QuickActionPanel.tsx`**: Quick action buttons
  - Join Bid, Lift Ask, Hit Bid, Join Ask
  - Quantity selector
  - Keyboard shortcut hints
  
- **`QuantityDialog.tsx`**: Modal for custom quantity input
  - Numeric input with validation
  - Quick size buttons
  - Confirm/Cancel
  
- **`OrderDragPreview.tsx`**: Visual feedback during drag
  - Line from drag source to cursor
  - Price level highlight on hover
  
- **`OrderContextMenu.tsx`**: Right-click menu for order actions
  - Modify, Cancel options
  - Keyboard shortcuts displayed

#### Enhanced Hooks
- **`useOrderBookInteraction.ts`**: Handle order book interactions
  ```typescript
  interface OrderBookInteraction {
    onPriceClick: (price: number, side: 'BUY' | 'SELL') => void;
    onQuickAction: (action: 'JOIN_BID' | 'LIFT_ASK' | 'HIT_BID' | 'JOIN_ASK') => void;
    onDragToPrice: (price: number, side: 'BUY' | 'SELL') => void;
    selectedLevel: number | null;
    defaultQuantity: number;
  }
  
  function useOrderBookInteraction(instrumentId: string): OrderBookInteraction {
    // Handle click, drag, keyboard events
    // Validate and place orders
    // Show confirmations and errors
  }
  ```

- **`useKeyboardShortcuts.ts`**: Keyboard navigation and shortcuts
  ```typescript
  function useKeyboardShortcuts(orderBook: OrderBook) {
    useEffect(() => {
      const handleKeyPress = (e: KeyboardEvent) => {
        switch (e.key) {
          case 'b': placeBuyOrder(); break;
          case 's': placeSellOrder(); break;
          case 'ArrowUp': navigateUp(); break;
          case 'ArrowDown': navigateDown(); break;
          case 'Enter': confirmOrder(); break;
        }
      };
      window.addEventListener('keydown', handleKeyPress);
      return () => window.removeEventListener('keydown', handleKeyPress);
    }, [orderBook]);
  }
  ```

#### State Management
- Store user preferences (default quantity, keyboard shortcuts enabled)
- Track selected price level for keyboard navigation
- Optimistic order updates (show order before server confirmation)
- Rollback on error

#### Accessibility
- ARIA labels for screen readers
- Keyboard navigation fully supported
- Focus indicators on selected price level
- Announce order placement results

## Dependencies

- US-11.1: Real-time Order Book (base UI)
- US-4.1.1: Order Placement (order API)
- US-4.1.2: Order Management (modify/cancel)

## Implementation Notes

### User Preference Storage
```typescript
interface OrderBookPreferences {
  defaultQuantity: number;
  quickSizeButtons: number[];
  keyboardShortcutsEnabled: boolean;
  confirmBeforePlacing: boolean;
  showTooltips: boolean;
}

// Store in localStorage or user profile
```

### Click vs Drag Detection
```typescript
let mouseDownTime: number;
let mouseDownPos: { x: number, y: number };

onMouseDown = (e) => {
  mouseDownTime = Date.now();
  mouseDownPos = { x: e.clientX, y: e.clientY };
};

onMouseUp = (e) => {
  const timeDiff = Date.now() - mouseDownTime;
  const distance = Math.sqrt(
    Math.pow(e.clientX - mouseDownPos.x, 2) +
    Math.pow(e.clientY - mouseDownPos.y, 2)
  );
  
  if (timeDiff < 200 && distance < 5) {
    // Click
    handlePriceClick(price);
  } else {
    // Drag
    handleDragEnd(price);
  }
};
```

### Optimistic Updates
```typescript
// Show order in book immediately
addOrderToBook(optimisticOrder);

// Send to server
placeOrder(order)
  .then((confirmedOrder) => {
    // Replace optimistic with confirmed
    replaceOrder(optimisticOrder.id, confirmedOrder);
  })
  .catch((error) => {
    // Rollback
    removeOrderFromBook(optimisticOrder.id);
    showError(error.message);
  });
```

### Edge Cases
- **Rapid Clicks**: Debounce to prevent duplicate orders (200ms)
- **Invalid Quantity**: Validate before sending to server
- **Insufficient Funds**: Show error immediately (client-side check)
- **Price Moved**: Warn if price changed between click and confirmation
- **Keyboard Focus**: Only activate shortcuts when order book is focused

## Testing Requirements

### Unit Tests
- [ ] Test click detection logic
- [ ] Test drag-to-price calculation
- [ ] Test keyboard shortcut handlers
- [ ] Test quantity validation
- [ ] Test optimistic update and rollback

### Integration Tests
- [ ] Test order placement from price click
- [ ] Test quick action buttons
- [ ] Test order modification via drag
- [ ] Test context menu actions

### E2E Scenarios
- [ ] User clicks on price level to place order
- [ ] User uses "Join Bid" quick action
- [ ] User drags order to new price level
- [ ] User navigates with keyboard and places order
- [ ] User modifies own order via right-click menu
- [ ] User receives error and order is rolled back

### Usability Testing
- [ ] Measure time to place order (target: <2 seconds)
- [ ] Test with professional traders for feedback
- [ ] Verify keyboard shortcuts are intuitive
- [ ] Ensure visual feedback is clear and immediate

## Audit Trail

| Date | Author | Change |
|------|--------|--------|
| 2026-01-18 | AI Assistant | Initial creation of US-11.4 for trader interaction layer |
