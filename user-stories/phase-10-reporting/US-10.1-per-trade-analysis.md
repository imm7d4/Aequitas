# US-10.1 - Universal Trade Diagnostics

**Epic:** Reporting & Analytics  
**Phase:** Phase 10 - Reporting & Analytics  
**Status:** Planning  
**Priority:** High  
**Complexity:** High  

## User Story

As a **professional trader**,  
I want a standalone, dedicated module for analyzing the microscopic details of **every completed (closed) trade**,  
so that I can understand the impact of commissions, slippage, and price excursion on my net profitability for closed positions only.

## Acceptance Criteria

### 1. Dedicated Diagnostics Module (Completed Trades Only)
- [ ] Feature is accessible via a new **"Trade Diagnostics"** item in the primary sidebar.
- [ ] **TradeResult Identity**: A `TradeResult` represents a fully closed economic unit created when FIFO-matched entry quantity reaches zero. Partial exits do not generate `TradeResult` records.
- [ ] No high-level aggregate summaries; focus is exclusively on the **Granular Closed Trade Log**.
- [ ] Data is only generated for **square-off events** (where an entry is matched with a corresponding exit).
- [ ] Supports filtering by Date, Instrument, and Side (Long/Short).

### 2. Deep Performance Metrics (Per Trade)
- [ ] **MAE / MFE Calculation Rules**:
  - **Lifetime**: Defined as the earliest entry timestamp to the final exit timestamp.
  - **MAE (Maximum Adverse Excursion)**: Deepest price against the position.
  - **MFE (Maximum Favorable Excursion)**: Peak price in favor of the position.
- [ ] **Short Trade Semantics**:
  - **Gross P&L**: (Entry Price - Exit Price) * Quantity.
  - **MAE**: Highest price reached during trade lifetime.
  - **MFE**: Lowest price reached during trade lifetime.
- [ ] **Dual P&L Calculation**:
  - **Gross P&L**: (Exit Price - Entry Price) * Quantity (Pre-commission).
  - **Net P&L**: Gross P&L - (Entry Commissions + Exit Commissions).
- [ ] **Exact Duration**: Millisecond-precision holding time between original entry and final square-off.
- [ ] **Return Analytics**: 
  - **Gross Return %**: Gross P&L / (Entry Notional).
  - **Net Return %**: Net P&L / (Entry Notional + Entry Commissions).

### 3. Visual Deep-Dive (Trade Detail View)
- [ ] **Expand Trade**: Ability to see all matching entry and exit orders in a table.
- [ ] **Opportunity Cost Indicator**: Visual comparison of actual exit price vs. the Maximum Favorable Price Achieved (MFE).

### 4. Advanced Logic & Governance
- [ ] **FIFO Matching**: Precision matching of trade legs for scale-in/scale-out scenarios.
- [ ] **Commission Scoping**: Accurate attribution of fees from both the entry transactions and exit transactions to the specific trade result.
- [ ] **Immutability**: Once a `TradeResult` is finalized and stored, it is immutable and never recalculated unless historical market data is explicitly reprocessed.
- [ ] **Versioning**: Include `CalculationVersion` field to allow for future logic improvements while maintaining historical consistency.

## Technical Requirements

### Backend
- **New Service**: `AnalyticsService`
  - Logic to scan order history and construct `TradeResult` records upon FIFO-zeroing.
  - **Market Data Priority**: 1. Snapshot tracker, 2. Intraday candle data (1m), 3. Trade execution prices (low accuracy flag).
- **Data Model**: `TradeResult`
  - `EntryOrderIDs[]`, `ExitOrderIDs[]` (Plural references for scale-in/out).
  - `GrossPNL`, `NetPNL`, `TotalCommissions`, `MAE`, `MFE`, `CalculationVersion`.

### Frontend
- **Navigation**: Update `Sidebar` with new "Diagnostics" icon (e.g., `Assessment`).
- **Pages**: New `TradeDiagnosticsPage` (`/diagnostics`).
- **Performance Contract**:
  - Load < 300ms for 1,000 trades.
  - Load < 800ms for 10,000 trades.

## Dependencies
- US-4.1.1 & US-6.1 (Order Execution)
- US-9.1 (Short Selling support)

## Implementation Notes
- **MAE/MFE Storage**: Requires post-trade query of OHLC data for the specific window.
- **Diagnostics vs Analysis**: The naming reflects the precision-audit nature of the feature.

## Testing Requirements
- [ ] **FIFO Accuracy**: Verified complex scale-in/out sequences (e.g., Buy-Buy-Sell-Sell).
- [ ] **MAE Inversion**: Correctness check for Short trade MAE/MFE logic.
- [ ] **Edge Cases**:
  - Partial exits that leave remainder open (No `TradeResult` generated).
  - Same-timestamp entry & exit (scalping).
  - Zero-duration trades.
  - High-volatility candles causing MAE > Gross loss.
- [ ] **Performance**: Validated against 10k trade records as per SLA.

## Audit Trail

| Date | Author | Change |
|------|--------|--------|
| 2026-01-17 | AI Assistant | Initial draft of US-10.1 |
| 2026-01-17 | AI Assistant | Revised for standalone sidebar, deep metrics (MAE/MFE), and separate commission calculation. Removed summary stats. |
| 2026-01-17 | AI Assistant | Comprehensive upgrade to "Trade Diagnostics": plural order IDs, MAE/MFE rules, Short semantics, Performance contract, Immutability, and Versioning. |
