# user-stories/phase-14-onboarding/US-14.1-onboarding-tour.md

## Title: New User Onboarding Tour

### User Story
**As a** new registered user,
**I want** to be guided through an interactive tour of the application features when I log in for the first time,
**So that** I understand how to use the application effectively and can get started quickly.

### Description
Upon the very first login after registration, the user should be presented with an interactive, step-by-step tour that highlights the key functionalities of the entire app. This tour should be visual and educational, using overlays to focus the user's attention.

### Specific Requirements

#### 1. Design Improvements

**1.1 Context-Aware Highlighting**
*   Ensure highlighted elements are visible within the viewport (auto-scroll if required).
*   Prevent highlighting elements that are hidden, disabled, or conditionally rendered.
*   Add fallback handling if a target element is not found (skip step gracefully).

**1.2 Responsive & Adaptive Behavior**
*   Tour must work across: Desktop, Tablet, Mobile.
*   Adjust tooltip placement dynamically to prevent overflow.
*   Ensure spotlight positioning recalculates on window resize.

**1.3 Accessibility (Critical Enhancement)**
*   Full keyboard support:
    *   `Enter`: Next
    *   `Esc`: Skip
    *   `Tab`: Focus navigation within overlay
*   Screen reader support (ARIA roles and labels).
*   Ensure sufficient contrast ratio for dimmed background and highlighted elements.

**1.4 UX Refinements**
*   Add progress indicator (e.g., "Step 2 of 5").
*   Include subtle animation easing for spotlight movement.
*   Prevent interaction with background elements while tour is active.
*   Add confirmation modal if user clicks "Skip".
*   Provide option in Settings to "Replay Tour".

**1.5 Smart Trigger Behavior**
*   Delay tour start by 500â€“1000ms after login to allow UI rendering.
*   Ensure tour only starts after:
    *   User profile is fully loaded.
    *   Dashboard API calls are complete.
*   Do not start tour if user lands on a deep-linked route.

**1.6 Performance Optimization**
*   Lazy-load tour library to reduce initial bundle size.
*   Avoid re-render loops when spotlight updates.
*   Cache step configuration in memory.

**1.7 Step Configuration Architecture**
*   Define tour steps in a central configuration object.
*   Each step should include:
    *   `targetSelector`
    *   `title`
    *   `description`
    *   `placement`
    *   `route` (optional)
*   Allow dynamic enabling/disabling of steps via feature flags.

#### 2. Implementation Improvements

**2.1 Backend Enhancements**
*   Add fields in User table:
    *   `is_onboarding_complete` (boolean, default false)
    *   `onboarding_skipped` (boolean, optional)
    *   `onboarding_completed_at` (datetime, nullable)
*   Create API endpoint:
    *   `PATCH /api/users/onboarding-status`
    *   Payload:
        ```json
        {
          "isOnboardingComplete": true,
          "skipped": false
        }
        ```
*   Ensure:
    *   Idempotent updates.
    *   Audit logging (optional but recommended).

**2.2 State Management Strategy (Frontend)**
*   Store onboarding state in: Global state (Redux / Context) OR React Query cache.
*   Maintain a local flag `isTourRunning` to prevent duplicate triggers.
*   Handle race conditions between login redirect and tour launch.

**2.3 Robust Error Handling**
*   If step target not found -> auto-skip step.
*   If API call fails when completing tour:
    *   Retry once.
    *   Fallback to `localStorage` to prevent re-showing.

**2.4 Navigation Handling**
*   If a step belongs to another route:
    *   Programmatically navigate.
    *   Wait for DOM render.
    *   Then highlight element.
*   Prevent user from manually navigating away during tour (optional guard).

**2.5 Security & Data Integrity**
*   Do NOT rely solely on frontend flag.
*   Backend must validate `is_onboarding_complete`.
*   Ensure flag cannot be manipulated via client tampering.

**2.6 Analytics & Tracking (Recommended)**
*   Track:
    *   Tour started
    *   Step viewed
    *   Tour completed
    *   Tour skipped
*   Enable drop-off analysis, UX optimization, and feature engagement measurement.

### Acceptance Criteria
- [ ] The tour launches automatically on the first login ONLY.
- [ ] The background is dimmed, active element is highlighted and visible (auto-scrolled).
- [ ] Text boxes and arrows correctly point to and explain the UI elements with improved a11y support.
- [ ] Animations are smooth, responsive, and re-position on resize.
- [ ] Keyboard navigation (`Enter`, `Esc`, `Tab`) works correctly.
- [ ] User can see progress (Step X of Y) and has control (Next/Prev/Skip).
- [ ] Skip confirmation modal appears when user attempts to skip.
- [ ] Backend receives update on tour completion/skip via `PATCH /api/users/onboarding-status`.
- [ ] Tour steps handle missing elements gracefully (auto-skip).
- [ ] User cannot interact with background elements during the tour.
- [ ] Replay Tour option exists in settings.
- [ ] Analytics events are fired for start, step view, complete, and skip.
