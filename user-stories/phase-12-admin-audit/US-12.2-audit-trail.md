# US-12.2 - Comprehensive Audit Trail

**Epic:** Admin & Audit Controls  
**Phase:** Phase 12 - Admin & Audit  
**Status:** Not Started  
**Priority:** Critical  
**Complexity:** High  

## User Story

As a **compliance officer / auditor**,  
I want a comprehensive, immutable audit trail of all critical system actions and user activities,  
so that I can ensure regulatory compliance, investigate incidents, and maintain accountability.

## Acceptance Criteria

### 1. Audit Event Capture
- [ ] Capture all critical events across the platform:
  - **User Events**: Registration, login, logout, password changes, profile updates
  - **Trading Events**: Order placement, modification, cancellation, execution
  - **Financial Events**: Deposits, withdrawals, balance adjustments, fee charges
  - **Admin Events**: User suspension, role changes, system config updates
  - **Security Events**: Failed login attempts, session timeouts, permission denials
  
- [ ] Each audit event must include:
  - Event ID (unique identifier)
  - Event type/category
  - User ID (who performed the action)
  - Target entity (what was affected)
  - Timestamp (with millisecond precision)
  - IP address and user agent
  - Before/after state (for modifications)
  - Result (success/failure)
  - Additional metadata (JSON)

### 2. Immutability & Integrity
- [ ] Audit logs are **append-only** (no updates or deletes)
- [ ] Each log entry has a cryptographic hash
- [ ] Chain of custody: Each entry references previous entry's hash
- [ ] Tamper detection: Verify hash chain integrity
- [ ] Write-once storage (consider WORM storage for compliance)

### 3. Audit Log Viewer (Admin UI)
- [ ] Dedicated audit log page in admin portal
- [ ] Advanced filtering:
  - Date range picker
  - Event type/category
  - User ID or username
  - IP address
  - Success/failure status
  - Entity type (Order, User, Account, etc.)
  
- [ ] Search functionality (full-text search on metadata)
- [ ] Sortable columns (timestamp, user, event type)
- [ ] Pagination (100 entries per page)
- [ ] Export to CSV/JSON for external analysis
- [ ] Detailed event view (expandable row showing full metadata)

### 4. Audit Reports
- [ ] Pre-built audit reports:
  - **User Activity Report**: All actions by a specific user
  - **Entity History Report**: All changes to a specific entity (e.g., order lifecycle)
  - **Security Report**: Failed logins, permission denials, suspicious activity
  - **Financial Report**: All balance changes, deposits, withdrawals
  - **Admin Actions Report**: All admin operations with justifications
  
- [ ] Scheduled reports (daily, weekly, monthly)
- [ ] Email delivery of reports to compliance team
- [ ] Report templates customizable by admin

### 5. Compliance Features
- [ ] **Data Retention**: Configurable retention policy (default: 7 years)
- [ ] **Archival**: Automatic archival of old logs to cold storage
- [ ] **Regulatory Export**: Export logs in standard formats (JSON, CSV, XML)
- [ ] **Audit Trail Verification**: Tool to verify log integrity (hash chain)
- [ ] **Access Control**: Only authorized users can view audit logs
- [ ] **Audit of Audits**: Log who accessed audit logs and when

## Technical Requirements

### Backend

#### New Model: `AuditLog`
```go
type AuditLog struct {
    ID            uint      `gorm:"primaryKey" json:"id"`
    EventID       string    `gorm:"uniqueIndex;not null" json:"event_id"` // UUID
    EventType     string    `gorm:"index;not null" json:"event_type"`
    Category      string    `gorm:"index;not null" json:"category"` // USER, TRADING, FINANCIAL, ADMIN, SECURITY
    UserID        *uint     `gorm:"index" json:"user_id"` // Nullable for system events
    TargetEntity  string    `json:"target_entity"` // e.g., "Order:12345"
    Action        string    `json:"action"` // e.g., "CREATE", "UPDATE", "DELETE"
    BeforeState   string    `gorm:"type:text" json:"before_state"` // JSON
    AfterState    string    `gorm:"type:text" json:"after_state"`  // JSON
    Result        string    `json:"result"` // SUCCESS, FAILURE
    ErrorMessage  string    `json:"error_message,omitempty"`
    IPAddress     string    `gorm:"index" json:"ip_address"`
    UserAgent     string    `json:"user_agent"`
    Metadata      string    `gorm:"type:text" json:"metadata"` // JSON for additional context
    Hash          string    `gorm:"not null" json:"hash"` // SHA-256 hash of this entry
    PreviousHash  string    `json:"previous_hash"` // Hash of previous entry (blockchain-style)
    Timestamp     time.Time `gorm:"index;not null" json:"timestamp"`
    CreatedAt     time.Time `json:"created_at"`
}

type AuditFilter struct {
    StartDate    *time.Time
    EndDate      *time.Time
    EventType    *string
    Category     *string
    UserID       *uint
    IPAddress    *string
    Result       *string
    SearchQuery  *string
}
```

#### New Service: `AuditService`
- **Method**: `LogEvent(event AuditEvent) error`
  - Create audit log entry
  - Calculate hash and chain to previous entry
  - Async write to database (non-blocking)
  
- **Method**: `GetAuditLogs(filter AuditFilter, pagination Pagination) ([]AuditLog, error)`
  - Fetch filtered audit logs
  
- **Method**: `GetEntityHistory(entityType, entityID string) ([]AuditLog, error)`
  - Get all audit logs for a specific entity
  
- **Method**: `VerifyIntegrity(startID, endID uint) (bool, error)`
  - Verify hash chain integrity for a range of logs
  
- **Method**: `ExportLogs(filter AuditFilter, format string) ([]byte, error)`
  - Export logs in CSV/JSON/XML format
  
- **Method**: `GenerateReport(reportType string, params map[string]interface{}) (*AuditReport, error)`
  - Generate pre-built audit reports

#### Middleware: `AuditMiddleware`
- Intercept all HTTP requests
- Log relevant events automatically
- Extract user context, IP, user agent
- Non-blocking audit log writes

#### Helper Functions
```go
func CalculateHash(log *AuditLog) string {
    // SHA-256 hash of event data
}

func GetPreviousHash() string {
    // Fetch hash of most recent audit log
}
```

#### New Endpoints
- `GET /api/admin/audit-logs` - Fetch audit logs with filters
- `GET /api/admin/audit-logs/:id` - Get specific audit log
- `GET /api/admin/audit-logs/entity/:type/:id` - Entity history
- `POST /api/admin/audit-logs/verify` - Verify integrity
- `POST /api/admin/audit-logs/export` - Export logs
- `GET /api/admin/audit-reports/:type` - Generate report

### Frontend

#### New Pages
- **`AuditLogPage.tsx`**: Main audit log viewer
  - Filter panel
  - Audit log table
  - Export button
  
- **`AuditReportsPage.tsx`**: Pre-built reports
  - Report selection
  - Parameter inputs
  - Report viewer/download

#### New Components
- **`AuditLogTable.tsx`**: Table with expandable rows
- **`AuditLogFilters.tsx`**: Advanced filter panel
- **`AuditLogDetail.tsx`**: Detailed event view (modal)
- **`IntegrityChecker.tsx`**: UI to verify log integrity
- **`AuditReportViewer.tsx`**: Display generated reports

#### New Hooks
- **`useAuditLogs.ts`**: Fetch and filter audit logs
- **`useAuditReports.ts`**: Generate and download reports

#### New Services
- **`auditService.ts`**: API integration for audit logs

## Dependencies

- US-12.1: Admin Dashboard (admin access control)
- US-0.1.3: Authentication (user context for logging)
- All other user stories (audit events from all features)

## Implementation Notes

### Hash Chain Implementation
```
Entry 1: Hash = SHA256(EventData1 + "")
Entry 2: Hash = SHA256(EventData2 + Hash1)
Entry 3: Hash = SHA256(EventData3 + Hash2)
...
```

### Performance Considerations
- **Async Logging**: Use message queue (e.g., Redis, RabbitMQ) for non-blocking writes
- **Batch Inserts**: Batch audit log inserts every 1 second
- **Partitioning**: Partition audit log table by date for faster queries
- **Indexing**: Index on timestamp, user_id, event_type, category
- **Archival**: Move logs older than 1 year to cold storage

### Security Considerations
- **Encryption**: Encrypt sensitive data in before/after states
- **Access Control**: Only admins and compliance officers can view logs
- **Audit of Audits**: Log who accessed audit logs
- **Tamper Detection**: Regular integrity checks (daily cron job)

### Edge Cases
- **High Volume**: Handle 1000+ events/second during peak trading
- **System Events**: Log events without user context (e.g., scheduled jobs)
- **Failed Writes**: Retry mechanism for failed audit log writes
- **Hash Chain Break**: Alert if hash chain verification fails

### Compliance Standards
- **SOX (Sarbanes-Oxley)**: Financial audit trail
- **GDPR**: User data access and modification logs
- **MiFID II**: Trade reporting and audit trail
- **ISO 27001**: Information security audit logs

## Testing Requirements

### Unit Tests
- [ ] Test hash calculation
- [ ] Test hash chain linking
- [ ] Test audit log creation
- [ ] Test filter logic

### Integration Tests
- [ ] Test audit log API with various filters
- [ ] Test entity history retrieval
- [ ] Test integrity verification
- [ ] Test log export in different formats

### E2E Scenarios
- [ ] User action triggers audit log entry
- [ ] Admin views audit logs with filters
- [ ] Admin exports audit logs to CSV
- [ ] Admin generates user activity report
- [ ] Integrity verification detects tampering (simulated)

### Performance Tests
- [ ] Load test: 1000 audit events/second
- [ ] Query performance: Filter 1M+ audit logs <2 seconds
- [ ] Export performance: Export 100K logs <10 seconds

## Audit Trail

| Date | Author | Change |
|------|--------|--------|
| 2026-01-18 | AI Assistant | Initial creation of US-12.2 |
