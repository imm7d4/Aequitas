# US-12.1 - Admin Dashboard & User Management

**Epic:** Admin & Audit Controls  
**Phase:** Phase 12 - Admin & Audit  
**Status:** Not Started  
**Priority:** High  
**Complexity:** High  

## User Story

As a **platform administrator**,  
I want a comprehensive admin dashboard to manage users, monitor system health, and control platform operations,  
so that I can ensure smooth platform operation, handle user issues, and maintain system integrity.

## Acceptance Criteria

### 1. Admin Dashboard Overview
- [ ] Dedicated admin portal accessible only to users with admin role
- [ ] Real-time system health metrics (CPU, memory, active connections)
- [ ] Key performance indicators (KPIs):
  - Total users, active users (last 24h)
  - Total orders placed today
  - Total trade volume (â‚¹)
  - System uptime
  - Error rate
- [ ] Quick action buttons for common admin tasks
- [ ] Alert notifications for critical system events

### 2. User Management
- [ ] **User List**: Paginated table of all registered users
  - Search by name, email, user ID
  - Filter by status (active, suspended, pending verification)
  - Sort by registration date, last login, trading volume
  
- [ ] **User Details View**: Comprehensive user profile
  - Personal information (name, email, phone, KYC status)
  - Trading account details (balance, margin, positions)
  - Order history and trade statistics
  - Login history and session information
  - Account activity timeline
  
- [ ] **User Actions**:
  - Suspend/unsuspend user account
  - Reset user password (send reset link)
  - Adjust user balance (with audit trail)
  - View user's active sessions
  - Force logout user
  - Add admin notes to user profile

### 3. Role-Based Access Control (RBAC)
- [ ] Define user roles: `USER`, `ADMIN`, `SUPER_ADMIN`, `SUPPORT`
- [ ] Assign roles to users
- [ ] Role-based permissions:
  - `USER`: Standard trading access
  - `SUPPORT`: View user data, read-only access
  - `ADMIN`: User management, system configuration
  - `SUPER_ADMIN`: Full access including role management
- [ ] Audit log for role changes

### 4. System Configuration
- [ ] **Trading Parameters**:
  - Enable/disable trading globally
  - Set market hours (override default)
  - Configure circuit breakers (price limits, volatility halts)
  - Set position limits per user
  
- [ ] **Fee Configuration**:
  - Update commission rates
  - Set fee caps and minimums
  - Configure margin requirements
  
- [ ] **Instrument Management**:
  - Enable/disable instruments for trading
  - Update instrument details (lot size, tick size)
  - Add new instruments to the platform

### 5. Monitoring & Alerts
- [ ] Real-time monitoring dashboard
- [ ] Alert configuration for:
  - High error rates (>5% in 5 minutes)
  - System resource usage (>80% CPU/memory)
  - Unusual trading activity (spike in orders)
  - Failed login attempts (potential security breach)
- [ ] Email/SMS notifications for critical alerts
- [ ] Alert history and resolution tracking

## Technical Requirements

### Backend

#### New Models
```go
type AdminUser struct {
    UserID    uint      `json:"user_id"`
    Role      string    `json:"role"` // USER, ADMIN, SUPER_ADMIN, SUPPORT
    CreatedAt time.Time `json:"created_at"`
    UpdatedAt time.Time `json:"updated_at"`
}

type SystemMetrics struct {
    CPUUsage       float64 `json:"cpu_usage"`
    MemoryUsage    float64 `json:"memory_usage"`
    ActiveSessions int     `json:"active_sessions"`
    TotalUsers     int     `json:"total_users"`
    ActiveUsers24h int     `json:"active_users_24h"`
    OrdersToday    int     `json:"orders_today"`
    TradeVolume    float64 `json:"trade_volume"`
    Uptime         int64   `json:"uptime"` // seconds
    ErrorRate      float64 `json:"error_rate"`
}

type UserManagementAction struct {
    ID          uint      `json:"id"`
    AdminID     uint      `json:"admin_id"`
    TargetUserID uint     `json:"target_user_id"`
    Action      string    `json:"action"` // SUSPEND, UNSUSPEND, BALANCE_ADJUST, etc.
    Reason      string    `json:"reason"`
    Metadata    string    `json:"metadata"` // JSON for additional details
    Timestamp   time.Time `json:"timestamp"`
}

type SystemConfig struct {
    Key         string    `json:"key"`
    Value       string    `json:"value"`
    Description string    `json:"description"`
    UpdatedBy   uint      `json:"updated_by"`
    UpdatedAt   time.Time `json:"updated_at"`
}
```

#### New Service: `AdminService`
- **Method**: `GetSystemMetrics() (*SystemMetrics, error)`
  - Collect real-time system health data
  - Calculate KPIs from database
  
- **Method**: `GetAllUsers(filters UserFilters, pagination Pagination) ([]User, error)`
  - Fetch paginated user list with filters
  
- **Method**: `GetUserDetails(userID uint) (*UserDetails, error)`
  - Comprehensive user profile with all related data
  
- **Method**: `SuspendUser(adminID, userID uint, reason string) error`
  - Suspend user account with audit trail
  
- **Method**: `AdjustUserBalance(adminID, userID uint, amount float64, reason string) error`
  - Modify user balance with validation and audit
  
- **Method**: `UpdateSystemConfig(adminID uint, key, value string) error`
  - Update system configuration with versioning

#### Middleware: `AdminAuthMiddleware`
- Verify user has admin role
- Check specific permissions for sensitive operations
- Log all admin actions

#### New Endpoints
- `GET /api/admin/dashboard` - System metrics and KPIs
- `GET /api/admin/users` - User list with filters
- `GET /api/admin/users/:id` - User details
- `POST /api/admin/users/:id/suspend` - Suspend user
- `POST /api/admin/users/:id/unsuspend` - Unsuspend user
- `POST /api/admin/users/:id/balance` - Adjust balance
- `GET /api/admin/config` - Get system configuration
- `PUT /api/admin/config/:key` - Update configuration
- `GET /api/admin/alerts` - Active alerts
- `POST /api/admin/alerts/:id/resolve` - Resolve alert

### Frontend

#### New Pages
- **`AdminDashboard.tsx`**: Main admin overview
  - System metrics cards
  - Recent activity feed
  - Quick actions panel
  
- **`UserManagementPage.tsx`**: User list and management
  - Searchable, filterable user table
  - Bulk actions support
  
- **`UserDetailsPage.tsx`**: Individual user profile
  - Tabbed interface (Profile, Trading, Orders, Activity)
  - Action buttons (suspend, adjust balance, etc.)
  
- **`SystemConfigPage.tsx`**: Configuration management
  - Grouped settings (Trading, Fees, System)
  - Edit forms with validation

#### New Components
- **`AdminSidebar.tsx`**: Admin-specific navigation
- **`SystemMetricsCard.tsx`**: KPI display cards
- **`UserTable.tsx`**: User list table with actions
- **`AlertPanel.tsx`**: Active alerts display
- **`AuditLog.tsx`**: Action history timeline

#### New Hooks
- **`useAdminAuth.ts`**: Admin role verification
- **`useSystemMetrics.ts`**: Real-time metrics polling
- **`useUserManagement.ts`**: User CRUD operations

#### Route Protection
- Admin routes protected by role-based guard
- Redirect non-admin users to 403 page

## Dependencies

- US-0.1.3: Authentication & Session Management (role-based auth)
- US-3.1.4: Account Finances (balance management)
- US-4.1.1: Order Management (order monitoring)

## Implementation Notes

### Security Considerations
- **Two-Factor Authentication**: Require 2FA for admin accounts
- **IP Whitelisting**: Restrict admin access to specific IPs (optional)
- **Session Timeout**: Shorter session timeout for admin users (15 minutes)
- **Audit Everything**: Log all admin actions with timestamp and reason
- **Sensitive Data**: Mask sensitive user data (passwords, full account numbers)

### Performance Considerations
- Cache system metrics for 5 seconds to reduce database load
- Paginate user lists (50 users per page)
- Lazy load user details on demand
- Use background jobs for bulk operations

### Edge Cases
- **Self-Suspension**: Prevent admin from suspending their own account
- **Last Admin**: Prevent removing admin role from last admin user
- **Balance Limits**: Validate balance adjustments (prevent negative balances)
- **Concurrent Edits**: Handle concurrent admin actions on same user

## Testing Requirements

### Unit Tests
- [ ] Test admin role verification
- [ ] Test user suspension logic
- [ ] Test balance adjustment with validation
- [ ] Test system config updates

### Integration Tests
- [ ] Test admin dashboard API
- [ ] Test user management endpoints
- [ ] Test role-based access control
- [ ] Test audit trail creation

### E2E Scenarios
- [ ] Admin logs in and views dashboard
- [ ] Admin searches for user and views details
- [ ] Admin suspends user account
- [ ] Admin adjusts user balance
- [ ] Admin updates system configuration
- [ ] Non-admin user cannot access admin routes

## Audit Trail

| Date | Author | Change |
|------|--------|--------|
| 2026-01-18 | AI Assistant | Initial creation of US-12.1 |
