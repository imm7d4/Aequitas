# US-12.3 - System Configuration & Risk Controls

**Epic:** Admin & Audit Controls  
**Phase:** Phase 12 - Admin & Audit  
**Status:** Not Started  
**Priority:** High  
**Complexity:** Medium  

## User Story

As a **platform administrator**,  
I want centralized system configuration and risk control management,  
so that I can dynamically adjust trading parameters, enforce risk limits, and respond to market conditions without code deployments.

## Acceptance Criteria

### 1. Trading Controls
- [ ] **Global Trading Switch**: Enable/disable all trading platform-wide
- [ ] **Instrument-Level Controls**: Enable/disable specific instruments
- [ ] **Market Hours Override**: Temporarily extend or restrict trading hours
- [ ] **Order Type Controls**: Enable/disable specific order types (MARKET, LIMIT, STOP, etc.)
- [ ] **Emergency Halt**: Immediate halt of all trading with one-click

### 2. Risk Limits & Circuit Breakers
- [ ] **Position Limits**:
  - Max position size per instrument per user
  - Max total portfolio value per user
  - Max leverage ratio
  
- [ ] **Price Limits**:
  - Daily price movement limits (e.g., ±10% from previous close)
  - Reject orders outside price bands
  
- [ ] **Volatility Circuit Breakers**:
  - Halt trading if price moves >X% in Y minutes
  - Configurable thresholds per instrument
  - Auto-resume after cooling period
  
- [ ] **Order Rate Limits**:
  - Max orders per user per minute
  - Max orders per instrument per minute
  - Prevent order spam and manipulation

### 3. Fee & Margin Configuration
- [ ] **Commission Structure**:
  - Percentage-based commission
  - Flat fee per order
  - Commission caps and minimums
  - Tiered pricing based on volume
  
- [ ] **Margin Requirements**:
  - Initial margin percentage
  - Maintenance margin percentage
  - Margin call thresholds
  - Liquidation thresholds

### 4. Configuration UI
- [ ] Dedicated System Configuration page in admin portal
- [ ] Grouped settings (Trading, Risk, Fees, Margins, Instruments)
- [ ] Edit forms with validation
- [ ] Preview changes before applying
- [ ] Confirmation dialog for critical changes
- [ ] Rollback capability (revert to previous config)

### 5. Configuration History & Versioning
- [ ] Track all configuration changes
- [ ] Show who made the change and when
- [ ] Reason/justification for each change
- [ ] Compare versions (diff view)
- [ ] Restore previous configuration

## Technical Requirements

### Backend

#### New Model: `SystemConfig`
```go
type SystemConfig struct {
    ID          uint      `gorm:"primaryKey" json:"id"`
    Category    string    `gorm:"index;not null" json:"category"` // TRADING, RISK, FEES, MARGINS
    Key         string    `gorm:"uniqueIndex;not null" json:"key"`
    Value       string    `gorm:"not null" json:"value"` // JSON for complex values
    DataType    string    `json:"data_type"` // STRING, NUMBER, BOOLEAN, JSON
    Description string    `json:"description"`
    IsActive    bool      `gorm:"default:true" json:"is_active"`
    UpdatedBy   uint      `json:"updated_by"`
    UpdatedAt   time.Time `json:"updated_at"`
    CreatedAt   time.Time `json:"created_at"`
}

type ConfigHistory struct {
    ID          uint      `gorm:"primaryKey" json:"id"`
    ConfigID    uint      `gorm:"index" json:"config_id"`
    OldValue    string    `json:"old_value"`
    NewValue    string    `json:"new_value"`
    ChangedBy   uint      `json:"changed_by"`
    Reason      string    `json:"reason"`
    Timestamp   time.Time `json:"timestamp"`
}

type CircuitBreaker struct {
    ID              uint      `gorm:"primaryKey" json:"id"`
    InstrumentID    uint      `gorm:"index" json:"instrument_id"`
    ThresholdPercent float64  `json:"threshold_percent"` // e.g., 5.0 for 5%
    TimeWindowMinutes int     `json:"time_window_minutes"`
    CoolingPeriodMinutes int  `json:"cooling_period_minutes"`
    IsActive        bool      `gorm:"default:true" json:"is_active"`
    LastTriggered   *time.Time `json:"last_triggered,omitempty"`
}
```

#### New Service: `ConfigService`
- **Method**: `GetConfig(key string) (string, error)`
  - Retrieve configuration value
  - Cache frequently accessed configs
  
- **Method**: `UpdateConfig(adminID uint, key, value, reason string) error`
  - Update configuration with validation
  - Create history entry
  - Invalidate cache
  - Trigger config reload
  
- **Method**: `GetConfigsByCategory(category string) ([]SystemConfig, error)`
  - Fetch all configs in a category
  
- **Method**: `GetConfigHistory(configID uint) ([]ConfigHistory, error)`
  - Fetch change history for a config
  
- **Method**: `RollbackConfig(adminID, historyID uint) error`
  - Restore previous configuration value

#### New Service: `RiskControlService`
- **Method**: `CheckPositionLimit(userID, instrumentID uint, quantity int) error`
  - Validate against position limits
  
- **Method**: `CheckPriceLimit(instrumentID uint, price float64) error`
  - Validate against price bands
  
- **Method**: `CheckCircuitBreaker(instrumentID uint, price float64) (bool, error)`
  - Check if circuit breaker should trigger
  
- **Method**: `TriggerCircuitBreaker(instrumentID uint) error`
  - Halt trading for instrument
  - Schedule auto-resume
  
- **Method**: `CheckOrderRateLimit(userID uint) error`
  - Validate order rate limits

#### Integration Points
- **OrderService**: Call risk checks before accepting orders
- **MatchingService**: Respect circuit breakers during matching
- **PortfolioService**: Enforce position limits

#### New Endpoints
- `GET /api/admin/config` - Get all configurations
- `GET /api/admin/config/:category` - Get configs by category
- `PUT /api/admin/config/:key` - Update configuration
- `GET /api/admin/config/:key/history` - Get change history
- `POST /api/admin/config/:key/rollback` - Rollback to previous value
- `GET /api/admin/circuit-breakers` - Get circuit breaker status
- `POST /api/admin/circuit-breakers/:id/trigger` - Manual trigger
- `POST /api/admin/circuit-breakers/:id/resume` - Resume trading

### Frontend

#### New Pages
- **`SystemConfigPage.tsx`**: Configuration management
  - Tabbed interface by category
  - Edit forms for each config
  - History viewer
  
- **`RiskControlsPage.tsx`**: Risk limits and circuit breakers
  - Position limits table
  - Circuit breaker status
  - Manual controls

#### New Components
- **`ConfigEditor.tsx`**: Edit individual config
  - Type-specific input (text, number, toggle, JSON editor)
  - Validation
  - Preview
  
- **`ConfigHistoryTimeline.tsx`**: Change history visualization
- **`CircuitBreakerPanel.tsx`**: Circuit breaker status and controls
- **`RiskLimitForm.tsx`**: Edit risk limits

#### New Hooks
- **`useSystemConfig.ts`**: Fetch and update configs
- **`useCircuitBreakers.ts`**: Monitor circuit breaker status

## Dependencies

- US-12.1: Admin Dashboard (admin access)
- US-12.2: Audit Trail (log config changes)
- US-4.1.1: Order Placement (risk checks integration)
- US-6.1: Matching Engine (circuit breaker integration)

## Implementation Notes

### Default Configurations
```json
{
  "TRADING_ENABLED": true,
  "MAX_POSITION_SIZE_PER_INSTRUMENT": 10000,
  "MAX_PORTFOLIO_VALUE": 10000000,
  "MAX_LEVERAGE": 5.0,
  "PRICE_LIMIT_PERCENT": 10.0,
  "CIRCUIT_BREAKER_THRESHOLD": 5.0,
  "CIRCUIT_BREAKER_TIME_WINDOW": 5,
  "CIRCUIT_BREAKER_COOLING_PERIOD": 15,
  "ORDER_RATE_LIMIT_PER_MINUTE": 100,
  "COMMISSION_RATE": 0.0003,
  "COMMISSION_CAP": 20.0,
  "INITIAL_MARGIN_PERCENT": 50.0,
  "MAINTENANCE_MARGIN_PERCENT": 25.0
}
```

### Configuration Caching
- Cache configs in memory (Redis or in-process)
- TTL: 60 seconds
- Invalidate on update
- Pub/sub for multi-instance deployments

### Risk Check Flow
```
Order Placement
  → Check Trading Enabled
  → Check Instrument Enabled
  → Check Market Hours
  → Check Order Rate Limit
  → Check Position Limit
  → Check Price Limit
  → Check Circuit Breaker
  → Accept/Reject Order
```

### Edge Cases
- **Concurrent Updates**: Use optimistic locking to prevent conflicts
- **Invalid Values**: Validate config values before saving
- **Critical Configs**: Require confirmation for sensitive changes
- **Emergency Halt**: Bypass normal validation for emergency halt

## Testing Requirements

### Unit Tests
- [ ] Test config retrieval and caching
- [ ] Test config update with validation
- [ ] Test position limit checks
- [ ] Test price limit checks
- [ ] Test circuit breaker logic
- [ ] Test order rate limiting

### Integration Tests
- [ ] Test config update triggers cache invalidation
- [ ] Test risk checks integrated with order placement
- [ ] Test circuit breaker halts trading
- [ ] Test auto-resume after cooling period

### E2E Scenarios
- [ ] Admin updates commission rate
- [ ] Admin sets position limit, user order rejected when limit exceeded
- [ ] Circuit breaker triggers on rapid price movement
- [ ] Admin manually halts trading globally
- [ ] Admin rolls back configuration to previous version

## Audit Trail

| Date | Author | Change |
|------|--------|--------|
| 2026-01-18 | AI Assistant | Initial creation of US-12.3 |
